#!/bin/sh

set -e  # Exit on first error

echo "Starting configure -------------------------------------------"

# ============================================================================
# PLATFORM DETECTION
# ============================================================================

# Detect platform
UNAME=$(uname -s)

case "${UNAME}" in
    Linux)
        echo "configure: Configuring for Linux"
        NPROC=$(nproc 2>/dev/null || echo 1)
        ;;
    Darwin)
        echo "configure: Configuring for macOS"
        NPROC=$(sysctl -n hw.logicalcpu 2>/dev/null || echo 1)
        ;;
    *)
        echo "Warning: Unknown platform ${UNAME}, using single processor"
        NPROC=1
        ;;
esac

# Ensure R_HOME is set
: "${R_HOME=$(R RHOME 2>/dev/null)}"
if test -z "${R_HOME}"; then
    echo "ERROR: Could not find R_HOME. Please ensure R is installed and in PATH."
    exit 1
fi
echo "Using R_HOME: ${R_HOME}"

# Get R compiler settings
CC=$("${R_HOME}/bin/R" CMD config CC)
CXX=$("${R_HOME}/bin/R" CMD config CXX)
CFLAGS=$("${R_HOME}/bin/R" CMD config CFLAGS)
CXXFLAGS=$("${R_HOME}/bin/R" CMD config CXXFLAGS)
FFLAGS=$("${R_HOME}/bin/R" CMD config FFLAGS)

# ============================================================================
# macOS ARCHITECTURE DETECTION (for Rosetta compatibility)
# ============================================================================

OSX_ARCH=""
if [ "${UNAME}" = "Darwin" ]; then
    # Use R's detected architecture, not uname -m (which may be wrong under Rosetta)
    OSX_ARCH=$("${R_HOME}/bin/Rscript" -e 'cat(R.version[["arch"]])' 2>/dev/null | tr -d '[:space:]')
    if [ -z "${OSX_ARCH}" ]; then
        echo "Warning: Could not detect R architecture, will use system default"
    else
        echo "Detected R target architecture: ${OSX_ARCH}"
        # Normalize architecture name
        case "${OSX_ARCH}" in
            aarch64)
                OSX_ARCH="arm64"
                echo "  Normalized to: ${OSX_ARCH}"
                ;;
        esac
    fi
fi

# ============================================================================
# DEPENDENCY DETECTION: CHOLMOD
# ============================================================================

echo "Searching for CHOLMOD library..."
CHOLMOD_LIBS=""
CHOLMOD_INCLUDE=""

# First attempt: pkg-config (most reliable)
if command -v pkg-config >/dev/null 2>&1; then
    if pkg-config --exists cholmod 2>/dev/null; then
        CHOLMOD_LIBS=$(pkg-config --libs cholmod 2>/dev/null)
        CHOLMOD_INCLUDE=$(pkg-config --cflags cholmod 2>/dev/null)
        echo "  Found CHOLMOD via pkg-config"
        echo "    CHOLMOD_LIBS: ${CHOLMOD_LIBS}"
        [ -n "${CHOLMOD_INCLUDE}" ] && echo "    CHOLMOD_INCLUDE: ${CHOLMOD_INCLUDE}"
    fi
fi

# Second attempt: Manual search with architecture-aware paths on macOS
if [ -z "${CHOLMOD_LIBS}" ]; then
    echo "  pkg-config unavailable/unsuccessful, searching standard locations..."
    
    if [ "${UNAME}" = "Darwin" ] && [ -n "${OSX_ARCH}" ]; then
        # macOS: Use R's target architecture for Homebrew path selection
        case "${OSX_ARCH}" in
            arm64)
                # Apple Silicon target: native Homebrew at /opt/homebrew
                search_paths="/opt/homebrew/lib /opt/homebrew/opt/suite-sparse/lib"
                ;;
            x86_64)
                # Intel target: Homebrew at /usr/local
                search_paths="/usr/local/lib /usr/local/opt/suite-sparse/lib"
                ;;
            *)
                # Unknown: search both
                search_paths="/opt/homebrew/lib /usr/local/lib /opt/local/lib"
                ;;
        esac
    else
        # Linux and other platforms: standard system paths
        search_paths="/usr/lib /usr/lib64 /usr/local/lib /usr/local/lib64 /opt/local/lib"
    fi
    
    for libdir in ${search_paths}; do
        if [ -f "${libdir}/libcholmod.a" ] || [ -f "${libdir}/libcholmod.so" ] || [ -f "${libdir}/libcholmod.dylib" ]; then
            echo "  Found CHOLMOD library in ${libdir}"
            CHOLMOD_LIBS="-L${libdir} -lcholmod"
            
            # Try to find corresponding include directory
            includedir="${libdir%/lib}/include"
            if [ -f "${includedir}/cholmod.h" ]; then
                CHOLMOD_INCLUDE="-I${includedir}"
            fi
            break
        fi
    done
fi

# Final fallback: rely on system library path
if [ -z "${CHOLMOD_LIBS}" ]; then
    echo "  Warning: CHOLMOD library not found in standard locations"
    echo "  Using -lcholmod (assuming system default search path)"
    CHOLMOD_LIBS="-lcholmod"
fi

echo "  Final CHOLMOD_LIBS: ${CHOLMOD_LIBS}"
[ -n "${CHOLMOD_INCLUDE}" ] && echo "  Final CHOLMOD_INCLUDE: ${CHOLMOD_INCLUDE}"
# ============================================================================
# OPENMP CONFIGURATION (from R)
# ============================================================================

echo "Using OpenMP flags from R..."
R_OPENMP_CXXFLAGS=$("${R_HOME}/bin/R" CMD config SHLIB_OPENMP_CXXFLAGS 2>/dev/null || true)
R_OPENMP_LDFLAGS=$("${R_HOME}/bin/R" CMD config SHLIB_OPENMP_LDFLAGS 2>/dev/null || true)

case "${R_OPENMP_CXXFLAGS}" in
    ERROR:*|*no\ information\ for\ variable*)
        R_OPENMP_CXXFLAGS=""
        ;;
esac
case "${R_OPENMP_LDFLAGS}" in
    ERROR:*|*no\ information\ for\ variable*)
        R_OPENMP_LDFLAGS=""
        ;;
esac

# Fallback: check user Makevars for OpenMP flags
if [ -z "${R_OPENMP_CXXFLAGS}" ] && [ -z "${R_OPENMP_LDFLAGS}" ]; then
    R_MAKEVARS_USER_PATH="${R_MAKEVARS_USER:-$("${R_HOME}/bin/R" CMD config R_MAKEVARS_USER 2>/dev/null || true)}"
    if [ -z "${R_MAKEVARS_USER_PATH}" ]; then
        R_MAKEVARS_USER_PATH="${HOME}/.R/Makevars"
    fi

    case "${R_MAKEVARS_USER_PATH}" in
        "~/"*)
            R_MAKEVARS_USER_PATH="${HOME}/${R_MAKEVARS_USER_PATH#~/}"
            ;;
    esac

    if [ -f "${R_MAKEVARS_USER_PATH}" ] && command -v make >/dev/null 2>&1; then
        makevars_eval() {
            _file="$1"
            _var="$2"
            make -s -f - VAR="${_var}" MAKEVARS_FILE="${_file}" print-var 2>/dev/null <<'EOF'
include $(MAKEVARS_FILE)
print-var:
	@echo $($(VAR))
EOF
        }

        R_OPENMP_CXXFLAGS=$(makevars_eval "${R_MAKEVARS_USER_PATH}" "SHLIB_OPENMP_CXXFLAGS")
        R_OPENMP_LDFLAGS=$(makevars_eval "${R_MAKEVARS_USER_PATH}" "SHLIB_OPENMP_LDFLAGS")
        echo "  SHLIB_OPENMP_CXXFLAGS (Makevars): ${R_OPENMP_CXXFLAGS}"
        echo "  SHLIB_OPENMP_LDFLAGS (Makevars): ${R_OPENMP_LDFLAGS}"
    fi
fi

echo "  SHLIB_OPENMP_CXXFLAGS: ${R_OPENMP_CXXFLAGS}"
echo "  SHLIB_OPENMP_LDFLAGS: ${R_OPENMP_LDFLAGS}"

if [ -z "${R_OPENMP_CXXFLAGS}" ] && [ -z "${R_OPENMP_LDFLAGS}" ]; then
    echo "  OpenMP disabled by R configuration"
elif [ -n "${R_OPENMP_CXXFLAGS}" ] && [ -z "${R_OPENMP_LDFLAGS}" ]; then
    echo "  Warning: SHLIB_OPENMP_LDFLAGS is empty. Add -L<libomp>/lib -lomp to link OpenMP on macOS."
fi

# Convert flags into CMake-friendly lists (semicolon-delimited)
R_OPENMP_CXXFLAGS_LIST=$(printf "%s" "${R_OPENMP_CXXFLAGS}" | tr ' \t' ';')
R_OPENMP_LDFLAGS_LIST=$(printf "%s" "${R_OPENMP_LDFLAGS}" | tr ' \t' ';')

# ============================================================================
# BUILD CONFIGURATION
# ============================================================================

# Compute absolute path for libactionet.a
ACTIONET_LIB_PATH="$(cd src && pwd)/lib/libactionet.a"
echo "libactionet will be built at: ${ACTIONET_LIB_PATH}"

# Generate Makevars from template
echo "Generating src/Makevars from template..."
cd src
sed \
    -e "s|@CHOLMOD_LIBS@|${CHOLMOD_LIBS}|g" \
    -e "s|@CHOLMOD_INCLUDE@|${CHOLMOD_INCLUDE}|g" \
    -e "s|@ACTIONET_LIB_PATH@|${ACTIONET_LIB_PATH}|g" \
    -e "s|@NPROC@|${NPROC}|g" \
    Makevars.in > Makevars

echo "Generated Makevars successfully"

# ============================================================================
# CMAKE BUILD OF libactionet
# ============================================================================

# Locate cmake
CMAKE_BIN=""
for cmake_path in cmake /opt/homebrew/bin/cmake /usr/local/bin/cmake; do
    if command -v "${cmake_path}" >/dev/null 2>&1; then
        CMAKE_BIN="${cmake_path}"
        break
    fi
done

if [ -z "${CMAKE_BIN}" ]; then
    echo "ERROR: cmake not found in PATH or common locations"
    exit 1
fi
echo "Using cmake: ${CMAKE_BIN}"

# Build libactionet
echo "Building libactionet static library..."
BUILD_DIR="lib"
mkdir -p "${BUILD_DIR}" && cd "${BUILD_DIR}" || exit 1

# Prepare CMake flags
CMAKE_FLAGS="-DCMAKE_BUILD_TYPE=Release"
CMAKE_FLAGS="${CMAKE_FLAGS} -DBUILD_SHARED_LIBS:bool=OFF"
CMAKE_FLAGS="${CMAKE_FLAGS} -DCMAKE_POSITION_INDEPENDENT_CODE:bool=ON"
CMAKE_FLAGS="${CMAKE_FLAGS} -DLIBACTIONET_BUILD_R=1"
CMAKE_FLAGS="${CMAKE_FLAGS} -DR_HOME='${R_HOME}'"
if [ -n "${R_OPENMP_CXXFLAGS_LIST}" ]; then
    CMAKE_FLAGS="${CMAKE_FLAGS} -DLIBACTIONET_OPENMP_CXXFLAGS=${R_OPENMP_CXXFLAGS_LIST}"
fi
if [ -n "${R_OPENMP_LDFLAGS_LIST}" ]; then
    CMAKE_FLAGS="${CMAKE_FLAGS} -DLIBACTIONET_OPENMP_LDFLAGS=${R_OPENMP_LDFLAGS_LIST}"
fi

# Add macOS architecture flag if detected
if [ "${UNAME}" = "Darwin" ] && [ -n "${OSX_ARCH}" ]; then
    CMAKE_FLAGS="${CMAKE_FLAGS} -DCMAKE_OSX_ARCHITECTURES=${OSX_ARCH}"
fi

# Configure and build
${CMAKE_BIN} -S ../libactionet ${CMAKE_FLAGS}
echo "Building with ${NPROC} processors..."
make -j"${NPROC}"

echo "Build complete!"
